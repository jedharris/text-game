# Phase 3: Treatment and Cure (Silvermoss)
# Tests that treating fungal infections reduces severity, stops progression, and cures completely

# Initial state: Aldric has severe infection (severity 80, damage 10)
ASSERT actors.npc_aldric.properties.conditions.fungal_infection.severity == 80
ASSERT actors.npc_aldric.properties.conditions.fungal_infection.damage_per_turn == 10
ASSERT actors.npc_aldric.properties.conditions.fungal_infection.progression_rate == 2
ASSERT actors.npc_aldric.properties.health == 40

# Navigate to Luminous Grotto to get silvermoss
# Note: These navigation turns will cause Aldric's infection to progress
# Each turn: severity +2, damage -10, regen +5, net -5 HP
go west
go down

# Take first silvermoss
take silvermoss

# Return to Aldric
go up

# After 4 turns of travel:
# - Aldric's severity: 80 + (2*4) = 88
# - Aldric's health: 40 - (5*4) = 20 HP
# Now give silvermoss to reduce severity by 40: 88 - 40 = 48

# Give first silvermoss to Aldric
# This should: reduce severity by 40, stop progression (rate=0), transition to "stabilized"
give silvermoss to aldric

# After first treatment:
# - Severity: 88 - 40 = 48 (moderate/severe boundary)
# - Progression_rate: 0 (stops progression)
# - Damage_per_turn: 4 (tier 40+), calculated by tick_conditions
# - State: "stabilized"
ASSERT actors.npc_aldric.properties.conditions.fungal_infection.severity == 48
ASSERT actors.npc_aldric.properties.conditions.fungal_infection.progression_rate == 0
ASSERT actors.npc_aldric.properties.conditions.fungal_infection.damage_per_turn == 4

# Aldric's health after 5 turns of damage at -5 HP/turn: 40 - 25 = 15 HP
ASSERT actors.npc_aldric.properties.health >= 14
ASSERT actors.npc_aldric.properties.health <= 16

# Wait 3 turns to see healing (net +1 HP/turn: 4 damage - 5 regen)
look
look
look

# After 3 turns of healing at net +1 HP/turn:
# - Severity stays at 48 (progression_rate = 0)
# - Health: 15 + (1*3) = 18 HP
ASSERT actors.npc_aldric.properties.conditions.fungal_infection.severity == 48
ASSERT actors.npc_aldric.properties.conditions.fungal_infection.damage_per_turn == 4
ASSERT actors.npc_aldric.properties.health >= 17
ASSERT actors.npc_aldric.properties.health <= 19

# Get second silvermoss
go down
take silvermoss
go up

# Give second silvermoss to Aldric
# This should: completely remove infection, transition to "recovering"
give silvermoss to aldric

# After second treatment:
# - Infection completely removed (no fungal_infection condition)
# - State: "recovering"
# - Health same or slightly higher
ASSERT actors.npc_aldric.properties.health >= 17
ASSERT actors.npc_aldric.properties.health <= 30

# Wait 5 turns to see full regeneration with no damage
look
look
look
look
look

# After 5 turns with no infection:
# - No fungal infection condition exists
# - Health increases at full 5 HP/turn regen rate
# - From ~26 HP: 26 + (5*5) = 51 HP
ASSERT actors.npc_aldric.properties.health >= 48
ASSERT actors.npc_aldric.properties.health <= 53

# SUCCESS: Complete treatment system works!
# - First silvermoss reduces severity by 40 and stops progression
# - Damage tiers update automatically based on new severity
# - Aldric heals slowly at net +1 HP/turn (stabilized)
# - Second silvermoss completely removes infection
# - Aldric heals quickly at full +5 HP/turn (recovering)
